<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Littlefield Technologies Simulator</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          fontFamily: { sans: ['Inter', 'system-ui', 'sans-serif'] },
          colors: {
            surface:  { DEFAULT: '#12121a', 50: '#1a1a2e', 100: '#16162a' },
            dark:     { DEFAULT: '#0a0a0f', 50: '#0e0e16' },
          },
          animation: {
            'fade-in': 'fadeIn 0.6s ease-out both',
            'slide-up': 'slideUp 0.5s ease-out both',
            'glow': 'glow 2s ease-in-out infinite alternate',
            'shimmer': 'shimmer 2s linear infinite',
          },
          keyframes: {
            fadeIn: { from: { opacity: '0' }, to: { opacity: '1' } },
            slideUp: { from: { opacity: '0', transform: 'translateY(20px)' }, to: { opacity: '1', transform: 'translateY(0)' } },
            glow: { from: { boxShadow: '0 0 20px rgba(99,102,241,0.15)' }, to: { boxShadow: '0 0 40px rgba(99,102,241,0.3)' } },
            shimmer: { '0%': { backgroundPosition: '-200% 0' }, '100%': { backgroundPosition: '200% 0' } },
          },
        },
      },
    };
  </script>
  <style>
    body { background: #0a0a0f; }
    ::-webkit-scrollbar { width: 6px; }
    ::-webkit-scrollbar-track { background: transparent; }
    ::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.08); border-radius: 3px; }
    ::-webkit-scrollbar-thumb:hover { background: rgba(255,255,255,0.15); }

    .card {
      background: rgba(18,18,26,0.8);
      backdrop-filter: blur(12px);
      border: 1px solid rgba(255,255,255,0.06);
      border-radius: 16px;
      padding: 24px;
      transition: border-color 0.3s, box-shadow 0.3s;
    }
    .card:hover { border-color: rgba(255,255,255,0.10); box-shadow: 0 8px 32px rgba(0,0,0,0.3); }

    .input-field {
      width: 100%;
      background: rgba(255,255,255,0.04);
      border: 1px solid rgba(255,255,255,0.08);
      border-radius: 10px;
      padding: 10px 14px;
      font-size: 14px;
      color: #e2e8f0;
      outline: none;
      transition: border-color 0.2s, box-shadow 0.2s;
    }
    .input-field:focus {
      border-color: rgba(129,140,248,0.5);
      box-shadow: 0 0 0 3px rgba(129,140,248,0.1);
    }
    .input-field option { background: #1a1a2e; color: #e2e8f0; }
    select.input-field { cursor: pointer; }

    .run-btn {
      background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 50%, #a78bfa 100%);
      color: white;
      font-weight: 700;
      font-size: 16px;
      padding: 16px 48px;
      border-radius: 14px;
      border: none;
      cursor: pointer;
      transition: transform 0.2s, box-shadow 0.3s;
      position: relative;
      overflow: hidden;
    }
    .run-btn:hover { transform: translateY(-2px); box-shadow: 0 12px 40px rgba(99,102,241,0.4); }
    .run-btn:active { transform: translateY(0); }
    .run-btn:disabled { opacity: 0.6; cursor: not-allowed; transform: none; }
    .run-btn::after {
      content: '';
      position: absolute;
      inset: 0;
      background: linear-gradient(90deg, transparent, rgba(255,255,255,0.15), transparent);
      background-size: 200% 100%;
      animation: shimmer 2s linear infinite;
    }

    .preset-btn {
      background: rgba(255,255,255,0.04);
      border: 1px solid rgba(255,255,255,0.08);
      color: #94a3b8;
      padding: 6px 16px;
      border-radius: 8px;
      font-size: 12px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s;
    }
    .preset-btn:hover { background: rgba(255,255,255,0.08); color: #e2e8f0; border-color: rgba(255,255,255,0.15); }
    .preset-btn.active { background: rgba(99,102,241,0.15); border-color: rgba(99,102,241,0.4); color: #a5b4fc; }

    .stat-glass {
      background: rgba(255,255,255,0.03);
      backdrop-filter: blur(8px);
      border: 1px solid rgba(255,255,255,0.06);
      border-radius: 16px;
      padding: 24px;
      position: relative;
      overflow: hidden;
    }
    .stat-glass .accent { position: absolute; top: 0; left: 0; right: 0; height: 3px; border-radius: 16px 16px 0 0; }

    .tl-row {
      display: grid;
      grid-template-columns: 80px 1fr 100px 40px;
      gap: 8px;
      align-items: center;
      padding: 8px 0;
      border-bottom: 1px solid rgba(255,255,255,0.04);
      animation: fadeIn 0.3s ease-out;
    }
    @media (max-width: 639px) {
      .tl-row {
        grid-template-columns: 1fr 1fr 40px;
        grid-template-rows: auto auto;
      }
      .tl-row .tl-action { grid-column: 1 / -1; }
    }
    .tl-row .input-field { padding: 8px 10px; font-size: 13px; }

    .remove-btn {
      width: 28px; height: 28px;
      display: flex; align-items: center; justify-content: center;
      border-radius: 8px;
      background: rgba(244,63,94,0.08);
      border: 1px solid rgba(244,63,94,0.15);
      color: #f43f5e;
      cursor: pointer;
      transition: all 0.2s;
      font-size: 16px;
    }
    .remove-btn:hover { background: rgba(244,63,94,0.2); border-color: rgba(244,63,94,0.4); }

    .section-label {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      font-size: 11px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: #64748b;
      margin-bottom: 20px;
    }
    .section-label::before {
      content: '';
      display: block;
      width: 20px;
      height: 1px;
      background: linear-gradient(90deg, transparent, #475569);
    }
    .section-label::after {
      content: '';
      display: block;
      flex: 1;
      min-width: 40px;
      height: 1px;
      background: linear-gradient(90deg, #475569, transparent);
    }

    .flow-step {
      display: flex; align-items: center; gap: 6px;
      padding: 6px 12px;
      border-radius: 8px;
      font-size: 11px;
      font-weight: 500;
      white-space: nowrap;
    }
    .flow-arrow { color: #475569; font-size: 14px; }

    .chart-card {
      background: rgba(18,18,26,0.8);
      backdrop-filter: blur(12px);
      border: 1px solid rgba(255,255,255,0.06);
      border-radius: 16px;
      padding: 20px 20px 16px;
    }
    .chart-title {
      font-size: 13px;
      font-weight: 600;
      color: #94a3b8;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      margin-bottom: 16px;
    }

    .results-section > * { animation: slideUp 0.5s ease-out both; }
    .results-section > *:nth-child(1) { animation-delay: 0.0s; }
    .results-section > *:nth-child(2) { animation-delay: 0.1s; }
    .results-section > *:nth-child(3) { animation-delay: 0.2s; }
    .results-section > *:nth-child(4) { animation-delay: 0.3s; }

    @keyframes countUp { from { opacity: 0; transform: translateY(8px); } to { opacity: 1; transform: translateY(0); } }

    .checkbox-custom {
      appearance: none; width: 18px; height: 18px; border: 1px solid rgba(255,255,255,0.15);
      border-radius: 5px; background: rgba(255,255,255,0.04); cursor: pointer;
      position: relative; transition: all 0.2s;
    }
    .checkbox-custom:checked { background: #6366f1; border-color: #6366f1; }
    .checkbox-custom:checked::after {
      content: ''; position: absolute; top: 2px; left: 5px;
      width: 5px; height: 9px;
      border: solid white; border-width: 0 2px 2px 0; transform: rotate(45deg);
    }
    .checkbox-custom:focus { box-shadow: 0 0 0 3px rgba(99,102,241,0.2); }

    .spinner { display: inline-block; width: 20px; height: 20px; border: 2.5px solid rgba(255,255,255,0.2); border-top-color: white; border-radius: 50%; animation: spin 0.6s linear infinite; }
    @keyframes spin { to { transform: rotate(360deg); } }

    /* Day scrubber */
    .scrubber-wrap { padding: 20px 24px 16px; }
    .scrubber-range {
      -webkit-appearance: none; appearance: none;
      width: 100%; height: 6px; border-radius: 3px;
      background: rgba(255,255,255,0.08);
      outline: none; cursor: pointer;
    }
    .scrubber-range::-webkit-slider-thumb {
      -webkit-appearance: none; appearance: none;
      width: 18px; height: 18px; border-radius: 50%;
      background: linear-gradient(135deg, #6366f1, #8b5cf6);
      border: 2px solid rgba(255,255,255,0.2);
      box-shadow: 0 2px 8px rgba(99,102,241,0.4);
      cursor: grab;
    }
    .scrubber-range::-webkit-slider-thumb:active { cursor: grabbing; transform: scale(1.1); }
    .scrubber-range::-moz-range-thumb {
      width: 18px; height: 18px; border-radius: 50%;
      background: linear-gradient(135deg, #6366f1, #8b5cf6);
      border: 2px solid rgba(255,255,255,0.2);
      box-shadow: 0 2px 8px rgba(99,102,241,0.4);
      cursor: grab;
    }
    .fork-btn {
      background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
      color: white; font-weight: 600; font-size: 13px;
      padding: 8px 20px; border-radius: 10px; border: none;
      cursor: pointer; transition: transform 0.2s, box-shadow 0.2s;
    }
    .fork-btn:hover { transform: translateY(-1px); box-shadow: 0 6px 20px rgba(99,102,241,0.35); }

    /* Guide button glow for first visit */
    .guide-glow {
      animation: guideGlow 2s ease-in-out infinite alternate;
      border-color: rgba(129,140,248,0.4) !important;
    }
    @keyframes guideGlow {
      from { box-shadow: 0 0 8px rgba(99,102,241,0.2); }
      to   { box-shadow: 0 0 20px rgba(99,102,241,0.5), 0 0 40px rgba(99,102,241,0.15); }
    }

    /* ━━ Disclaimer Modal ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ */
    .disclaimer-overlay {
      position: fixed;
      inset: 0;
      z-index: 9999;
      display: flex;
      align-items: center;
      justify-content: center;
      background: rgba(0, 0, 0, 0.7);
      backdrop-filter: blur(8px);
      -webkit-backdrop-filter: blur(8px);
      animation: fadeIn 0.3s ease-out;
    }
    .disclaimer-overlay.hidden { display: none; }
    .disclaimer-card {
      background: rgba(18, 18, 26, 0.95);
      backdrop-filter: blur(20px);
      border: 1px solid rgba(99, 102, 241, 0.2);
      border-radius: 20px;
      padding: 40px 36px 32px;
      max-width: 540px;
      width: 90%;
      box-shadow: 0 24px 80px rgba(0, 0, 0, 0.6), 0 0 60px rgba(99, 102, 241, 0.08);
      animation: slideUp 0.4s ease-out;
    }
    .disclaimer-card h2 {
      font-size: 20px;
      font-weight: 800;
      color: #f1f5f9;
      margin-bottom: 20px;
      letter-spacing: -0.01em;
    }
    .disclaimer-card p {
      font-size: 13.5px;
      line-height: 1.7;
      color: #94a3b8;
      margin-bottom: 12px;
    }
    .disclaimer-card p:last-of-type { margin-bottom: 0; }
    .disclaimer-card .accent-line {
      width: 48px;
      height: 3px;
      border-radius: 2px;
      background: linear-gradient(90deg, #6366f1, #8b5cf6);
      margin-bottom: 20px;
    }
    .disclaimer-btn {
      background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 50%, #a78bfa 100%);
      color: white;
      font-weight: 700;
      font-size: 15px;
      padding: 14px 40px;
      border-radius: 12px;
      border: none;
      cursor: pointer;
      transition: transform 0.2s, box-shadow 0.3s;
      position: relative;
      overflow: hidden;
      display: block;
      width: 100%;
      margin-top: 24px;
    }
    .disclaimer-btn:hover { transform: translateY(-2px); box-shadow: 0 12px 40px rgba(99, 102, 241, 0.4); }
    .disclaimer-btn:active { transform: translateY(0); }
    .disclaimer-btn::after {
      content: '';
      position: absolute;
      inset: 0;
      background: linear-gradient(90deg, transparent, rgba(255,255,255,0.15), transparent);
      background-size: 200% 100%;
      animation: shimmer 2s linear infinite;
    }
    .disclaimer-link {
      color: #818cf8;
      text-decoration: none;
      transition: color 0.2s;
    }
    .disclaimer-link:hover { color: #a5b4fc; }
  </style>
</head>
<body class="min-h-screen text-slate-300">

  <!-- ━━ Header ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ -->
  <header class="relative overflow-hidden border-b border-white/5">
    <div class="absolute inset-0 bg-gradient-to-br from-indigo-950/50 via-transparent to-violet-950/30"></div>
    <div class="absolute top-0 left-1/4 w-96 h-96 bg-indigo-500/5 rounded-full blur-3xl"></div>
    <div class="absolute bottom-0 right-1/4 w-64 h-64 bg-violet-500/5 rounded-full blur-3xl"></div>

    <div class="relative max-w-7xl mx-auto px-6 py-10">
      <div class="flex items-center justify-between gap-4 mb-2">
        <div class="flex items-center gap-3">
          <div class="w-10 h-10 rounded-xl bg-gradient-to-br from-indigo-500 to-violet-600 flex items-center justify-center shadow-lg shadow-indigo-500/20">
            <svg class="w-5 h-5 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
              <path stroke-linecap="round" stroke-linejoin="round" d="M19.428 15.428a2 2 0 00-1.022-.547l-2.387-.477a6 6 0 00-3.86.517l-.318.158a6 6 0 01-3.86.517L6.05 15.21a2 2 0 00-1.806.547M8 4h8l-1 1v5.172a2 2 0 00.586 1.414l5 5c1.26 1.26.367 3.414-1.415 3.414H4.828c-1.782 0-2.674-2.154-1.414-3.414l5-5A2 2 0 009 10.172V5L8 4z" />
            </svg>
          </div>
          <div>
            <h1 class="text-2xl font-extrabold text-white tracking-tight">Littlefield Technologies</h1>
            <p class="text-sm text-indigo-300/70">Discrete-Event Factory Simulator</p>
          </div>
        </div>
        <a id="guide-btn" href="/guide" onclick="localStorage.setItem('guide_seen','true')" class="hidden sm:inline-flex items-center gap-2 px-4 py-2 rounded-xl text-sm font-medium text-slate-300 bg-white/[0.04] border border-white/[0.08] hover:bg-white/[0.08] hover:border-white/[0.15] transition-all backdrop-blur-sm">
          <svg class="w-4 h-4 text-indigo-400" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253"/></svg>
          How to Play
        </a>
      </div>

      <!-- Factory flow diagram -->
      <div class="mt-6 flex flex-wrap items-center gap-2 text-slate-400">
        <div class="flow-step bg-amber-500/10 text-amber-400 border border-amber-500/20">
          <svg class="w-3.5 h-3.5" fill="currentColor" viewBox="0 0 20 20"><rect x="2" y="4" width="16" height="12" rx="1"/></svg>
          S1 Stuffing</div>
        <span class="flow-arrow">&rarr;</span>
        <div class="flow-step bg-rose-500/10 text-rose-400 border border-rose-500/20">
          <svg class="w-3.5 h-3.5" fill="currentColor" viewBox="0 0 20 20"><path d="M10 2a8 8 0 100 16 8 8 0 000-16zm1 11H9v-2h2v2zm0-4H9V5h2v4z"/></svg>
          S2 Testing</div>
        <span class="flow-arrow">&rarr;</span>
        <div class="flow-step bg-blue-500/10 text-blue-400 border border-blue-500/20">
          <svg class="w-3.5 h-3.5" fill="currentColor" viewBox="0 0 20 20"><path d="M11 3a1 1 0 10-2 0v1a1 1 0 102 0V3zM15.657 5.757a1 1 0 00-1.414-1.414l-.707.707a1 1 0 001.414 1.414l.707-.707zM18 10a1 1 0 01-1 1h-1a1 1 0 110-2h1a1 1 0 011 1zM5.05 6.464A1 1 0 106.464 5.05l-.707-.707a1 1 0 00-1.414 1.414l.707.707zM5 10a1 1 0 01-1 1H3a1 1 0 110-2h1a1 1 0 011 1z"/><path d="M10 18a8 8 0 100-16 8 8 0 000 16zm0-2a6 6 0 110-12 6 6 0 010 12z"/></svg>
          S3 Tuning</div>
        <span class="flow-arrow">&rarr;</span>
        <div class="flow-step bg-rose-500/10 text-rose-400 border border-rose-500/20">
          <svg class="w-3.5 h-3.5" fill="currentColor" viewBox="0 0 20 20"><path d="M10 2a8 8 0 100 16 8 8 0 000-16zm1 11H9v-2h2v2zm0-4H9V5h2v4z"/></svg>
          S2 Re-test</div>
        <span class="flow-arrow">&rarr;</span>
        <div class="flow-step bg-emerald-500/10 text-emerald-400 border border-emerald-500/20">
          <svg class="w-3.5 h-3.5" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/></svg>
          Revenue</div>
      </div>
    </div>
  </header>

  <main class="max-w-7xl mx-auto px-4 sm:px-6 py-10 space-y-10">

    <!-- ━━ Fixed Costs & Rules ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ -->
    <details class="rounded-2xl bg-white/[0.02] border border-white/5 px-6 py-3 group">
      <summary class="flex items-center gap-3 cursor-pointer select-none text-[11px] font-semibold text-slate-500 uppercase tracking-wider">
        <svg class="w-3 h-3 text-slate-600 transition-transform group-open:rotate-90" fill="currentColor" viewBox="0 0 20 20"><path d="M6.293 4.293a1 1 0 011.414 0L14 10.586a1 1 0 01-1.414 1.414L6.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd" fill-rule="evenodd" transform="rotate(0 10 10)"/></svg>
        Fixed Costs &amp; Rules
      </summary>
      <div class="flex flex-wrap items-center gap-x-8 gap-y-2 text-[11px] pt-3 pb-1 border-t border-white/5 mt-3">
        <span class="text-slate-500">Buy stuffer <span class="text-amber-400/70">$90K</span></span>
        <span class="text-slate-500">Buy tester <span class="text-rose-400/70">$80K</span></span>
        <span class="text-slate-500">Buy tuner <span class="text-blue-400/70">$100K</span></span>
        <span class="text-slate-500">Sell any machine <span class="text-slate-400">$10K</span></span>
        <span class="text-slate-600">&middot;</span>
        <span class="text-slate-500">Kit cost <span class="text-slate-400">$10/kit + $1K shipping</span></span>
        <span class="text-slate-500">Supplier lead time <span class="text-slate-400">4 days</span></span>
        <span class="text-slate-500">Order size <span class="text-slate-400">60 kits</span></span>
        <span class="text-slate-600">&middot;</span>
        <span class="text-slate-500">Cash interest <span class="text-emerald-400/70">+10%/yr</span></span>
        <span class="text-slate-500">Debt interest <span class="text-rose-400/70">&minus;20%/yr</span></span>
        <span class="text-slate-600">&middot;</span>
        <span class="text-slate-500">Management window <span class="text-slate-400">Day 50&ndash;385</span></span>
      </div>
    </details>

    <!-- ━━ Configuration ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ -->
    <div>
      <div class="section-label">Starting State <span id="day-badge" class="ml-2 px-2 py-0.5 rounded-md bg-indigo-500/10 text-indigo-400/70 text-[10px] font-semibold tracking-normal normal-case">Day 0</span></div>
      <div class="grid grid-cols-1 md:grid-cols-2 gap-5">

        <!-- Factory -->
        <div class="card">
          <div class="flex items-center gap-2 mb-5">
            <div class="w-8 h-8 rounded-lg bg-amber-500/10 flex items-center justify-center">
              <svg class="w-4 h-4 text-amber-400" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"/></svg>
            </div>
            <h2 class="text-sm font-semibold text-white">Factory</h2>
          </div>
          <div class="grid grid-cols-3 gap-4">
            <div>
              <label class="block text-xs font-medium text-amber-400/80 mb-1.5">S1 Stuffers</label>
              <input id="stuffers" type="number" value="3" min="1" max="20" class="input-field" oninput="updateFinalState()">
            </div>
            <div>
              <label class="block text-xs font-medium text-rose-400/80 mb-1.5">S2 Testers</label>
              <input id="testers" type="number" value="2" min="1" max="20" class="input-field" oninput="updateFinalState()">
            </div>
            <div>
              <label class="block text-xs font-medium text-blue-400/80 mb-1.5">S3 Tuners</label>
              <input id="tuners" type="number" value="1" min="1" max="20" class="input-field" oninput="updateFinalState()">
            </div>
          </div>
        </div>

        <!-- Strategy -->
        <div class="card">
          <div class="flex items-center gap-2 mb-5">
            <div class="w-8 h-8 rounded-lg bg-violet-500/10 flex items-center justify-center">
              <svg class="w-4 h-4 text-violet-400" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M13 10V3L4 14h7v7l9-11h-7z"/></svg>
            </div>
            <h2 class="text-sm font-semibold text-white">Strategy</h2>
          </div>
          <div class="grid grid-cols-3 gap-4">
            <div>
              <label class="block text-xs font-medium text-slate-400 mb-1.5">Contract</label>
              <select id="contract" class="input-field" onchange="updateFinalState()">
                <option value="1" selected>C1 &mdash; $750</option>
                <option value="2">C2 &mdash; $1,000</option>
                <option value="3">C3 &mdash; $1,250</option>
              </select>
            </div>
            <div>
              <label class="block text-xs font-medium text-slate-400 mb-1.5">Lot Size</label>
              <select id="lot_size" class="input-field" onchange="updateFinalState()">
                <option value="60" selected>60 (1 lot)</option>
                <option value="30">30 (2 lots)</option>
                <option value="20">20 (3 lots)</option>
                <option value="12">12 (5 lots)</option>
              </select>
            </div>
            <div class="flex items-end pb-2">
              <div class="flex items-center gap-2.5">
                <input id="priority_step4" type="checkbox" class="checkbox-custom" onchange="updateFinalState()">
                <label for="priority_step4" class="text-xs text-slate-400 cursor-pointer">S2 Priority&nbsp;Step&nbsp;4</label>
              </div>
            </div>
          </div>
        </div>

        <!-- Inventory -->
        <div class="card">
          <div class="flex items-center gap-2 mb-5">
            <div class="w-8 h-8 rounded-lg bg-blue-500/10 flex items-center justify-center">
              <svg class="w-4 h-4 text-blue-400" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4"/></svg>
            </div>
            <h2 class="text-sm font-semibold text-white">Inventory</h2>
          </div>
          <div class="grid grid-cols-3 gap-4">
            <div>
              <label class="block text-xs font-medium text-slate-400 mb-1.5">Initial Kits</label>
              <input id="initial_inventory" type="number" value="9600" min="0" max="100000" class="input-field">
            </div>
            <div>
              <label class="block text-xs font-medium text-slate-400 mb-1.5">Reorder Point</label>
              <input id="reorder_point" type="number" value="1800" min="0" max="50000" class="input-field" oninput="updateFinalState()">
            </div>
            <div>
              <label class="block text-xs font-medium text-slate-400 mb-1.5">Order Quantity</label>
              <input id="order_quantity" type="number" value="3600" min="0" max="50000" class="input-field" oninput="updateFinalState()">
              <p class="text-[11px] text-slate-500 mt-1">0 = stop ordering</p>
            </div>
          </div>
        </div>

        <!-- Simulation -->
        <div class="card">
          <div class="flex items-center gap-2 mb-5">
            <div class="w-8 h-8 rounded-lg bg-emerald-500/10 flex items-center justify-center">
              <svg class="w-4 h-4 text-emerald-400" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.066 2.573c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.573 1.066c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.066-2.573c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"/><path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/></svg>
            </div>
            <h2 class="text-sm font-semibold text-white">Simulation</h2>
          </div>
          <div class="grid grid-cols-2 gap-4 mb-4">
            <div>
              <label class="block text-xs font-medium text-slate-400 mb-1.5">Start Day</label>
              <input id="start_day" type="number" value="0" min="0" max="485" class="input-field" oninput="updateDayBadge()">
              <p class="text-[11px] text-slate-500 mt-1">0 = from scratch</p>
            </div>
            <div>
              <label class="block text-xs font-medium text-slate-400 mb-1.5">Initial Cash</label>
              <input id="initial_cash" type="number" value="0" step="1000" class="input-field">
              <p class="text-[11px] text-slate-500 mt-1">$ at start day</p>
            </div>
          </div>
          <div class="grid grid-cols-3 gap-4">
            <div>
              <label class="block text-xs font-medium text-slate-400 mb-1.5">End Day</label>
              <input id="end_day" type="number" value="485" min="50" max="1000" class="input-field">
            </div>
            <div>
              <label class="block text-xs font-medium text-slate-400 mb-1.5">Interarrival (days)</label>
              <input id="interarrival_mean" type="number" value="0.125" min="0.05" max="2" step="0.01" class="input-field">
              <p class="text-[11px] text-slate-500 mt-1">0.125 = ~8/day</p>
            </div>
            <div>
              <label class="block text-xs font-medium text-slate-400 mb-1.5">Random Seed</label>
              <input id="seed" type="number" value="42" min="1" max="999999" class="input-field">
            </div>
          </div>
        </div>
      </div>

    </div>

    <!-- ━━ Action Plan ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ -->
    <div>
      <div class="section-label">Action Plan</div>
      <div class="card">
        <div class="flex flex-wrap items-center justify-between gap-4 mb-5">
          <p class="text-xs text-slate-500">Schedule actions during your management window <span class="text-slate-600">(Day 50 &ndash; 385)</span> &middot; <a href="/guide#action-failures" class="text-indigo-400/70 hover:text-indigo-300 transition-colors">Some actions can fail &rarr;</a></p>
          <div class="flex flex-wrap gap-2" id="preset-btns">
            <button onclick="loadPreset('conservative', this)" class="preset-btn">Conservative</button>
            <button onclick="loadPreset('balanced', this)" class="preset-btn active" id="preset-balanced">Balanced</button>
            <button onclick="loadPreset('aggressive', this)" class="preset-btn">Aggressive</button>
            <button onclick="loadPreset('clear', this)" class="preset-btn" style="color:#f43f5e; border-color: rgba(244,63,94,0.15);">Clear</button>
          </div>
        </div>
        <div class="flex items-center gap-2.5 mb-4">
          <input id="defer_buys" type="checkbox" class="checkbox-custom">
          <label for="defer_buys" class="text-xs text-slate-400 cursor-pointer">Retry failed purchases daily until affordable</label>
        </div>

        <!-- Timeline header (hidden on mobile since layout changes) -->
        <div class="hidden sm:grid grid-cols-[80px_1fr_100px_40px] gap-2 text-[10px] font-semibold text-slate-600 uppercase tracking-wider pb-2 border-b border-white/5 mb-1">
          <span>Day</span><span>Action</span><span>Value</span><span></span>
        </div>
        <div id="timeline-body"></div>

        <button onclick="addRow()" class="mt-4 flex items-center gap-1.5 text-xs font-medium text-indigo-400 hover:text-indigo-300 transition-colors">
          <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 4v16m8-8H4"/></svg>
          Add Action
        </button>
      </div>

      <!-- Final State -->
      <div class="section-label mt-8">Planned State <span class="ml-2 px-2 py-0.5 rounded-md bg-emerald-500/10 text-emerald-400/70 text-[10px] font-semibold tracking-normal normal-case">Day 385</span> <span class="ml-1 text-[10px] font-normal normal-case tracking-normal text-slate-600">assumes all actions succeed</span></div>
      <div id="final-state" class="rounded-2xl bg-white/[0.02] border border-white/5 px-6 py-4">
        <div class="flex flex-wrap items-center gap-x-6 gap-y-2 text-[11px]">
          <span class="text-slate-500">S1 <span id="fs-s1" class="text-amber-400/80 font-semibold">3</span></span>
          <span class="text-slate-500">S2 <span id="fs-s2" class="text-rose-400/80 font-semibold">2</span></span>
          <span class="text-slate-500">S3 <span id="fs-s3" class="text-blue-400/80 font-semibold">1</span></span>
          <span class="text-slate-600">&middot;</span>
          <span class="text-slate-500">Contract <span id="fs-contract" class="text-slate-300 font-semibold">C1</span></span>
          <span class="text-slate-500">Lot <span id="fs-lot" class="text-slate-300 font-semibold">60</span></span>
          <span class="text-slate-500">Priority S4 <span id="fs-prio" class="text-slate-300 font-semibold">Off</span></span>
          <span class="text-slate-600">&middot;</span>
          <span class="text-slate-500">ROP <span id="fs-rop" class="text-slate-300 font-semibold">1800</span></span>
          <span class="text-slate-500">ROQ <span id="fs-roq" class="text-slate-300 font-semibold">3600</span></span>
        </div>
      </div>
    </div>

    <!-- ━━ Run Button ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ -->
    <div class="flex justify-center py-4">
      <button id="run-btn" onclick="runSim()" class="run-btn animate-glow">
        <span id="run-label" class="relative z-10 flex items-center gap-2">
          <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2.5"><path stroke-linecap="round" stroke-linejoin="round" d="M14.752 11.168l-3.197-2.132A1 1 0 0010 9.87v4.263a1 1 0 001.555.832l3.197-2.132a1 1 0 000-1.664z"/><path stroke-linecap="round" stroke-linejoin="round" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
          Run Simulation
        </span>
      </button>
    </div>

    <!-- ━━ Results ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ -->
    <div id="results" class="hidden results-section space-y-8">

      <div id="warnings-box" class="hidden rounded-2xl bg-gradient-to-r from-rose-500/5 to-orange-500/5 border border-rose-500/15 p-5">
        <div class="flex items-center gap-2 mb-3">
          <svg class="w-4 h-4 text-rose-400" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd"/></svg>
          <span class="text-xs font-semibold text-rose-300/80 uppercase tracking-wider">Actions Blocked</span>
        </div>
        <ul id="warnings-list" class="space-y-1.5 text-sm text-rose-200/70"></ul>
        <a href="/guide#action-failures" class="inline-block mt-3 text-xs text-rose-300/50 hover:text-rose-300/80 transition-colors">Why do actions fail? &rarr;</a>
      </div>

      <div class="section-label">Results</div>

      <!-- Day Scrubber -->
      <div id="scrubber-card" class="card scrubber-wrap">
        <div class="flex items-center justify-between mb-3">
          <div class="flex items-center gap-3">
            <span class="text-xs font-semibold text-slate-400 uppercase tracking-wider">Snapshot at Day</span>
            <span id="scrub-day-label" class="text-lg font-bold text-white font-mono">0</span>
          </div>
          <button id="fork-btn" onclick="forkFromDay()" class="fork-btn">Plan from Day <span id="fork-day-label">0</span></button>
        </div>
        <input id="scrub-range" type="range" min="0" max="485" value="485" step="1" class="scrubber-range w-full" oninput="onScrubInput()" onchange="onScrubChange()">
        <div id="scrub-readout" class="mt-3 grid grid-cols-2 sm:grid-cols-5 gap-3 text-center">
          <div>
            <p class="text-[10px] text-slate-500 uppercase tracking-wider mb-0.5">S1 Stuffers</p>
            <p id="scrub-s1" class="text-sm font-semibold text-amber-300 font-mono">3</p>
          </div>
          <div>
            <p class="text-[10px] text-slate-500 uppercase tracking-wider mb-0.5">S2 Testers</p>
            <p id="scrub-s2" class="text-sm font-semibold text-rose-300 font-mono">2</p>
          </div>
          <div>
            <p class="text-[10px] text-slate-500 uppercase tracking-wider mb-0.5">S3 Tuners</p>
            <p id="scrub-s3" class="text-sm font-semibold text-blue-300 font-mono">1</p>
          </div>
          <div>
            <p class="text-[10px] text-slate-500 uppercase tracking-wider mb-0.5">Cash</p>
            <p id="scrub-cash" class="text-sm font-semibold text-emerald-300 font-mono">$0</p>
          </div>
          <div>
            <p class="text-[10px] text-slate-500 uppercase tracking-wider mb-0.5">Inventory</p>
            <p id="scrub-inv" class="text-sm font-semibold text-violet-300 font-mono">0</p>
          </div>
        </div>
      </div>

      <!-- Summary Stats -->
      <div class="grid grid-cols-2 lg:grid-cols-4 gap-4">
        <div class="stat-glass">
          <div class="accent bg-gradient-to-r from-emerald-500 to-emerald-400"></div>
          <div class="flex items-center gap-2 mb-3">
            <div class="w-7 h-7 rounded-lg bg-emerald-500/10 flex items-center justify-center">
              <svg class="w-3.5 h-3.5 text-emerald-400" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
            </div>
            <span class="text-[10px] font-semibold text-emerald-400/60 uppercase tracking-wider">Final Cash</span>
          </div>
          <p id="stat-cash" class="text-2xl font-bold text-white">&mdash;</p>
        </div>

        <div class="stat-glass">
          <div class="accent bg-gradient-to-r from-blue-500 to-cyan-400"></div>
          <div class="flex items-center gap-2 mb-3">
            <div class="w-7 h-7 rounded-lg bg-blue-500/10 flex items-center justify-center">
              <svg class="w-3.5 h-3.5 text-blue-400" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
            </div>
            <span class="text-[10px] font-semibold text-blue-400/60 uppercase tracking-wider">Avg Lead Time</span>
          </div>
          <p id="stat-lt" class="text-2xl font-bold text-white">&mdash;</p>
        </div>

        <div class="stat-glass">
          <div class="accent bg-gradient-to-r from-violet-500 to-purple-400"></div>
          <div class="flex items-center gap-2 mb-3">
            <div class="w-7 h-7 rounded-lg bg-violet-500/10 flex items-center justify-center">
              <svg class="w-3.5 h-3.5 text-violet-400" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-6 9l2 2 4-4"/></svg>
            </div>
            <span class="text-[10px] font-semibold text-violet-400/60 uppercase tracking-wider">Orders Done</span>
          </div>
          <p id="stat-orders" class="text-2xl font-bold text-white">&mdash;</p>
        </div>

        <div class="stat-glass">
          <div class="accent bg-gradient-to-r from-amber-500 to-orange-400"></div>
          <div class="flex items-center gap-2 mb-3">
            <div class="w-7 h-7 rounded-lg bg-amber-500/10 flex items-center justify-center">
              <svg class="w-3.5 h-3.5 text-amber-400" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6"/></svg>
            </div>
            <span class="text-[10px] font-semibold text-amber-400/60 uppercase tracking-wider">Avg Rev / Order</span>
          </div>
          <p id="stat-rev" class="text-2xl font-bold text-white">&mdash;</p>
        </div>
      </div>

      <!-- Charts -->
      <div class="grid grid-cols-1 lg:grid-cols-2 gap-5">
        <div class="chart-card">
          <div class="chart-title flex items-center gap-2">
            <span class="w-2 h-2 rounded-full bg-emerald-400"></span> Cash Over Time
          </div>
          <canvas id="chart-cash"></canvas>
        </div>
        <div class="chart-card">
          <div class="chart-title flex items-center gap-2">
            <span class="w-2 h-2 rounded-full bg-blue-400"></span> Lead Times
          </div>
          <canvas id="chart-lt"></canvas>
        </div>
        <div class="chart-card">
          <div class="chart-title flex items-center gap-2">
            <span class="w-2 h-2 rounded-full bg-rose-400"></span> Station Utilization
            <span class="relative ml-auto group">
              <svg class="w-3.5 h-3.5 text-slate-600 hover:text-slate-400 transition-colors cursor-help" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"/></svg>
              <span class="pointer-events-none absolute bottom-full right-0 mb-2 w-52 rounded-lg bg-surface-50 border border-white/10 px-3 py-2 text-[11px] text-slate-400 leading-relaxed opacity-0 group-hover:opacity-100 transition-opacity shadow-xl z-10">7-day rolling average of daily busy-time fraction per machine</span>
            </span>
          </div>
          <canvas id="chart-util"></canvas>
        </div>
        <div class="chart-card">
          <div class="chart-title flex items-center gap-2">
            <span class="w-2 h-2 rounded-full bg-violet-400"></span> Kit Inventory
          </div>
          <canvas id="chart-inv"></canvas>
        </div>
      </div>
    </div>
  </main>

  <!-- Footer -->
  <footer class="border-t border-white/5 mt-16">
    <div class="max-w-7xl mx-auto px-6 py-8 flex flex-wrap items-center justify-between gap-4">
      <div class="flex items-center gap-2 text-xs text-slate-600">
        <div class="w-5 h-5 rounded bg-gradient-to-br from-indigo-500 to-violet-600 flex items-center justify-center">
          <svg class="w-3 h-3 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M19.428 15.428a2 2 0 00-1.022-.547l-2.387-.477a6 6 0 00-3.86.517l-.318.158a6 6 0 01-3.86.517L6.05 15.21a2 2 0 00-1.806.547M8 4h8l-1 1v5.172a2 2 0 00.586 1.414l5 5c1.26 1.26.367 3.414-1.415 3.414H4.828c-1.782 0-2.674-2.154-1.414-3.414l5-5A2 2 0 009 10.172V5L8 4z"/></svg>
        </div>
        Littlefield Technologies Simulator
      </div>
      <p class="text-[11px] text-slate-700">Yale MGT 422 &middot; Operations Engine</p>
      <p class="text-[11px] text-slate-700 mt-1">Built with AI &middot; <a href="https://github.com/mahaddad/littlefield-sim" class="disclaimer-link">View on GitHub</a></p>
    </div>
  </footer>

  <!-- Disclaimer Modal -->
  <div id="disclaimer-overlay" class="disclaimer-overlay">
    <div class="disclaimer-card">
      <div class="accent-line"></div>
      <h2>Welcome to Littlefield Simulator</h2>
      <p>This simulator was developed as an <strong style="color:#e2e8f0">AI-assisted educational tool</strong> to complement the Littlefield Technologies exercise. It was built in just a few hours using <a href="https://claude.ai" class="disclaimer-link">Claude</a> to demonstrate the potential of AI-assisted development.</p>
      <p>It is designed to help you develop <strong style="color:#e2e8f0">deeper intuition</strong> about operations management concepts through interactive experimentation. Test hypotheses, explore trade-offs, and build understanding of how capacity, inventory, and contract decisions interact.</p>
      <p>This tool is <strong style="color:#e2e8f0">not intended to replace</strong> the analytical thinking required by the assignment. What matters most in your learning is the intuition you develop along the way, not the final result.</p>
      <p>Source code available on <a href="https://github.com/mahaddad/littlefield-sim" class="disclaimer-link">GitHub</a>.</p>
      <button id="disclaimer-dismiss" class="disclaimer-btn" onclick="dismissDisclaimer()">I Understand</button>
    </div>
  </div>

<script>
/* ━━ Presets ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ */

const PRESETS = {
  conservative: [
    { day: 55,  action: "buy_tester",          value: 1 },
    { day: 60,  action: "set_reorder_point",    value: 3600 },
    { day: 60,  action: "set_order_quantity",    value: 5400 },
    { day: 120, action: "set_contract",          value: 2 },
  ],
  balanced: [
    { day: 55,  action: "buy_tester",            value: 1 },
    { day: 55,  action: "buy_tuner",              value: 1 },
    { day: 60,  action: "set_reorder_point",      value: 3600 },
    { day: 60,  action: "set_order_quantity",      value: 5400 },
    { day: 90,  action: "set_contract",            value: 2 },
  ],
  aggressive: [
    { day: 55,  action: "buy_tester",              value: 1 },
    { day: 60,  action: "set_reorder_point",        value: 3600 },
    { day: 60,  action: "set_order_quantity",        value: 5400 },
    { day: 75,  action: "buy_tester",              value: 1 },
    { day: 80,  action: "set_contract",              value: 2 },
    { day: 100, action: "buy_tuner",                value: 1 },
    { day: 120, action: "set_contract",              value: 3 },
    { day: 120, action: "set_priority_step4",        value: 1 },
  ],
};

const ACTIONS = [
  { v: "buy_stuffer",        l: "Buy Stuffer(s) — $90K" },
  { v: "buy_tester",         l: "Buy Tester(s) — $80K" },
  { v: "buy_tuner",          l: "Buy Tuner(s) — $100K" },
  { v: "sell_stuffer",       l: "Sell Stuffer(s) — $10K" },
  { v: "sell_tester",        l: "Sell Tester(s) — $10K" },
  { v: "sell_tuner",         l: "Sell Tuner(s) — $10K" },
  { v: "set_contract",       l: "Switch Contract (1/2/3)" },
  { v: "set_lot_size",       l: "Set Lot Size" },
  { v: "set_reorder_point",  l: "Set Reorder Point" },
  { v: "set_order_quantity", l: "Set Order Quantity" },
  { v: "set_priority_step4", l: "Priority Step 4 (0/1)" },
];

/* ━━ Timeline ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ */

function addRow(day, action = "buy_tester", value = 1) {
  if (day === undefined) day = Math.max(Number(document.getElementById("start_day").value) || 0, 50);
  const body = document.getElementById("timeline-body");
  const row = document.createElement("div");
  row.className = "tl-row";
  const opts = ACTIONS.map(a =>
    `<option value="${a.v}" ${a.v === action ? "selected" : ""}>${a.l}</option>`
  ).join("");
  row.innerHTML = `
    <input type="number" value="${day}" min="0" max="485" class="input-field tl-day" placeholder="Day" oninput="updateFinalState()">
    <select class="input-field tl-action" onchange="updateFinalState()">${opts}</select>
    <input type="number" value="${value}" min="0" max="50000" class="input-field tl-value" placeholder="Value" oninput="updateFinalState()">
    <button onclick="this.parentElement.remove(); updateFinalState()" class="remove-btn">&times;</button>
  `;
  body.appendChild(row);
  updateFinalState();
}

function loadPreset(name, btn) {
  document.getElementById("timeline-body").innerHTML = "";
  document.querySelectorAll("#preset-btns .preset-btn").forEach(b => b.classList.remove("active"));
  if (btn) btn.classList.add("active");
  if (name !== "clear") (PRESETS[name] || []).forEach(a => addRow(a.day, a.action, a.value));
  updateFinalState();
}

/* ━━ Final State ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ */

function updateFinalState() {
  const n = id => Number(document.getElementById(id).value);
  const state = {
    s1: n("stuffers"), s2: n("testers"), s3: n("tuners"),
    contract: n("contract"), lot: n("lot_size"),
    prio: document.getElementById("priority_step4").checked,
    rop: n("reorder_point"), roq: n("order_quantity"),
  };

  // walk timeline actions in day order
  const rows = [];
  document.querySelectorAll(".tl-row").forEach(row => {
    rows.push({
      day:    Number(row.querySelector(".tl-day").value),
      action: row.querySelector(".tl-action").value,
      value:  Number(row.querySelector(".tl-value").value),
    });
  });
  rows.sort((a, b) => a.day - b.day);

  for (const r of rows) {
    const v = r.value;
    switch (r.action) {
      case "buy_stuffer":  state.s1 += v; break;
      case "buy_tester":   state.s2 += v; break;
      case "buy_tuner":    state.s3 += v; break;
      case "sell_stuffer":       state.s1 = Math.max(1, state.s1 - v); break;
      case "sell_tester":        state.s2 = Math.max(1, state.s2 - v); break;
      case "sell_tuner":         state.s3 = Math.max(1, state.s3 - v); break;
      case "set_contract":       state.contract = v; break;
      case "set_lot_size":       state.lot = v; break;
      case "set_reorder_point":  state.rop = v; break;
      case "set_order_quantity": state.roq = v; break;
      case "set_priority_step4": state.prio = !!v; break;
    }
  }

  const cNames = { 1: "C1", 2: "C2", 3: "C3" };
  document.getElementById("fs-s1").textContent = state.s1;
  document.getElementById("fs-s2").textContent = state.s2;
  document.getElementById("fs-s3").textContent = state.s3;
  document.getElementById("fs-contract").textContent = cNames[state.contract] || "C" + state.contract;
  document.getElementById("fs-lot").textContent = state.lot;
  document.getElementById("fs-prio").textContent = state.prio ? "On" : "Off";
  document.getElementById("fs-rop").textContent = state.rop.toLocaleString();
  document.getElementById("fs-roq").textContent = state.roq.toLocaleString();
}

/* ━━ Config ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ */

function getConfig() {
  const n = id => Number(document.getElementById(id).value);
  const timeline = [];
  document.querySelectorAll(".tl-row").forEach(row => {
    timeline.push({
      day:    Number(row.querySelector(".tl-day").value),
      action: row.querySelector(".tl-action").value,
      value:  Number(row.querySelector(".tl-value").value),
    });
  });
  return {
    stuffers: n("stuffers"), testers: n("testers"), tuners: n("tuners"),
    lot_size: n("lot_size"), contract: n("contract"),
    priority_step4: document.getElementById("priority_step4").checked,
    defer_buys: document.getElementById("defer_buys").checked,
    initial_inventory: n("initial_inventory"),
    reorder_point: n("reorder_point"), order_quantity: n("order_quantity"),
    start_day: n("start_day"), initial_cash: Number(document.getElementById("initial_cash").value),
    end_day: n("end_day"), interarrival_mean: Number(document.getElementById("interarrival_mean").value),
    seed: n("seed"), timeline,
  };
}

/* ━━ Charts ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ */

Chart.defaults.color = '#64748b';
Chart.defaults.borderColor = 'rgba(255,255,255,0.04)';
Chart.defaults.font.family = 'Inter';
Chart.defaults.font.size = 11;

let charts = {};
function killCharts() { Object.values(charts).forEach(c => c.destroy()); charts = {}; }

function mk(id, cfg) {
  charts[id] = new Chart(document.getElementById(id).getContext("2d"), cfg);
}

function gradient(ctx, c1, c2) {
  const g = ctx.createLinearGradient(0, 0, 0, 300);
  g.addColorStop(0, c1); g.addColorStop(1, c2); return g;
}

function renderCharts(c) {
  killCharts();
  const cashCtx = document.getElementById("chart-cash").getContext("2d");
  const invCtx  = document.getElementById("chart-inv").getContext("2d");

  mk("chart-cash", {
    type: "line",
    data: {
      labels: c.cash.map(p => p[0]),
      datasets: [{
        data: c.cash.map(p => p[1]),
        borderColor: "#34d399",
        backgroundColor: gradient(cashCtx, "rgba(52,211,153,0.15)", "rgba(52,211,153,0)"),
        fill: true, tension: 0.4, pointRadius: 0, borderWidth: 2,
      }],
    },
    options: {
      responsive: true,
      plugins: { legend: { display: false }, tooltip: { callbacks: { label: ctx => "$" + Math.round(ctx.parsed.y).toLocaleString() } } },
      scales: {
        x: { grid: { display: false }, ticks: { maxTicksLimit: 10 }, title: { display: true, text: "Day", color: "#475569" } },
        y: { ticks: { callback: v => "$" + (v/1000).toFixed(0) + "K" }, title: { display: true, text: "Cash", color: "#475569" } },
      },
    },
  });

  mk("chart-lt", {
    type: "scatter",
    data: {
      datasets: [{
        data: c.lead_times.map(p => ({ x: p[0], y: p[1] })),
        backgroundColor: "rgba(96,165,250,0.35)",
        borderColor: "rgba(96,165,250,0.6)",
        pointRadius: 1.2, pointHoverRadius: 4, borderWidth: 0.5,
      }],
    },
    options: {
      responsive: true,
      plugins: { legend: { display: false }, tooltip: { callbacks: { label: ctx => ctx.parsed.y.toFixed(3) + " days" } } },
      scales: {
        x: { grid: { display: false }, ticks: { maxTicksLimit: 10 }, title: { display: true, text: "Day", color: "#475569" } },
        y: { min: 0, title: { display: true, text: "Lead Time (days)", color: "#475569" } },
      },
    },
  });

  mk("chart-util", {
    type: "line",
    data: {
      labels: c.util_0.map(p => p[0]),
      datasets: [
        { label: "S1 Stuffing", data: c.util_0.map(p => p[1]), borderColor: "#fbbf24", borderWidth: 1.5, tension: 0.4, pointRadius: 0, backgroundColor: "transparent" },
        { label: "S2 Testing",  data: c.util_1.map(p => p[1]), borderColor: "#f43f5e", borderWidth: 2,   tension: 0.4, pointRadius: 0, backgroundColor: "transparent" },
        { label: "S3 Tuning",   data: c.util_2.map(p => p[1]), borderColor: "#60a5fa", borderWidth: 1.5, tension: 0.4, pointRadius: 0, backgroundColor: "transparent" },
      ],
    },
    options: {
      responsive: true,
      plugins: { legend: { position: "top", labels: { boxWidth: 10, padding: 16, usePointStyle: true, pointStyle: "circle" } } },
      scales: {
        x: { grid: { display: false }, ticks: { maxTicksLimit: 10 }, title: { display: true, text: "Day", color: "#475569" } },
        y: { min: 0, max: 1, ticks: { callback: v => (v*100).toFixed(0) + "%" }, title: { display: true, text: "Utilization", color: "#475569" } },
      },
    },
  });

  mk("chart-inv", {
    type: "line",
    data: {
      labels: c.inventory.map(p => p[0]),
      datasets: [{
        data: c.inventory.map(p => p[1]),
        borderColor: "#a78bfa",
        backgroundColor: gradient(invCtx, "rgba(167,139,250,0.12)", "rgba(167,139,250,0)"),
        fill: true, tension: 0.4, pointRadius: 0, borderWidth: 2,
      }],
    },
    options: {
      responsive: true,
      plugins: { legend: { display: false }, tooltip: { callbacks: { label: ctx => ctx.parsed.y.toLocaleString() + " kits" } } },
      scales: {
        x: { grid: { display: false }, ticks: { maxTicksLimit: 10 }, title: { display: true, text: "Day", color: "#475569" } },
        y: { min: 0, title: { display: true, text: "Kits on Hand", color: "#475569" } },
      },
    },
  });
}

/* ━━ Run ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ */

let _lastData = null;
let _fullCharts = null;

async function runSim() {
  const btn = document.getElementById("run-btn");
  const label = document.getElementById("run-label");
  btn.disabled = true;
  label.innerHTML = '<span class="spinner"></span> Simulating...';

  try {
    const resp = await fetch("/simulate", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(getConfig()),
    });
    const data = await resp.json();
    if (data.error) { alert("Error: " + data.error); return; }

    _lastData = data;
    _fullCharts = JSON.parse(JSON.stringify(data.charts));

    // Show warnings for blocked actions
    const wBox = document.getElementById("warnings-box");
    const wList = document.getElementById("warnings-list");
    if (data.warnings && data.warnings.length > 0) {
      wList.innerHTML = data.warnings.map(w => `<li>${w}</li>`).join("");
      wBox.classList.remove("hidden");
    } else {
      wBox.classList.add("hidden");
    }

    const s = data.summary;
    const startDay = s.start_day || 0;
    const endDay = Number(document.getElementById("end_day").value);
    const fmt = n => "$" + Math.round(n).toLocaleString();

    document.getElementById("stat-cash").textContent    = fmt(s.final_cash);
    document.getElementById("stat-lt").textContent       = s.avg_lead_time.toFixed(2) + " days";
    document.getElementById("stat-orders").textContent    = s.orders_completed.toLocaleString();
    document.getElementById("stat-rev").textContent       = fmt(s.avg_revenue);

    renderCharts(data.charts);

    // Set up scrubber
    const slider = document.getElementById("scrub-range");
    slider.min = startDay;
    slider.max = endDay;
    slider.value = endDay;
    _scrubDay = endDay;
    updateScrubReadout(endDay);

    const results = document.getElementById("results");
    results.classList.remove("hidden");
    results.style.animation = 'none';
    results.offsetHeight;
    results.style.animation = null;
    results.scrollIntoView({ behavior: "smooth", block: "start" });

  } catch (e) {
    alert("Request failed: " + e.message);
  } finally {
    btn.disabled = false;
    label.innerHTML = `
      <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2.5"><path stroke-linecap="round" stroke-linejoin="round" d="M14.752 11.168l-3.197-2.132A1 1 0 0010 9.87v4.263a1 1 0 001.555.832l3.197-2.132a1 1 0 000-1.664z"/><path stroke-linecap="round" stroke-linejoin="round" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
      Run Simulation`;
  }
}

/* ━━ Day Badge ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ */

function updateDayBadge() {
  const badge = document.getElementById("day-badge");
  const sd = Number(document.getElementById("start_day").value) || 0;
  badge.textContent = "Day " + sd;
}

/* ━━ Day Scrubber ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ */

let _scrubDay = 0;
let _scrubTimer = null;

function onScrubInput() {
  const day = Number(document.getElementById("scrub-range").value);
  _scrubDay = day;
  document.getElementById("scrub-day-label").textContent = day;
  document.getElementById("fork-day-label").textContent = day;
  updateScrubReadout(day);
  clearTimeout(_scrubTimer);
  _scrubTimer = setTimeout(() => scrubToDay(day), 80);
}

function onScrubChange() {
  const day = Number(document.getElementById("scrub-range").value);
  _scrubDay = day;
  clearTimeout(_scrubTimer);
  scrubToDay(day);
}

function updateScrubReadout(day) {
  if (!_fullCharts) return;
  document.getElementById("scrub-day-label").textContent = day;
  document.getElementById("fork-day-label").textContent = day;

  const mach = _fullCharts.machines || [];
  let m = mach.length > 0 ? mach[0][1] : [3, 2, 1];
  for (const entry of mach) { if (entry[0] <= day) m = entry[1]; else break; }
  document.getElementById("scrub-s1").textContent = m[0];
  document.getElementById("scrub-s2").textContent = m[1];
  document.getElementById("scrub-s3").textContent = m[2];

  const cashArr = _fullCharts.cash || [];
  let cash = 0;
  for (const entry of cashArr) { if (entry[0] <= day) cash = entry[1]; else break; }
  document.getElementById("scrub-cash").textContent = "$" + Math.round(cash).toLocaleString();

  const invArr = _fullCharts.inventory || [];
  let inv = 0;
  for (const entry of invArr) { if (entry[0] <= day) inv = entry[1]; else break; }
  document.getElementById("scrub-inv").textContent = inv.toLocaleString();
}

function scrubToDay(day) {
  if (!_fullCharts || !charts["chart-cash"]) return;

  function filterTS(arr) { return arr.filter(e => e[0] <= day); }

  const cashF = filterTS(_fullCharts.cash);
  const ltF   = filterTS(_fullCharts.lead_times);
  const revF  = filterTS(_fullCharts.revenue || []);

  const fmt = n => "$" + Math.round(n).toLocaleString();
  const lts = ltF.map(e => e[1]);
  const revs = revF.map(e => e[1]);

  document.getElementById("stat-cash").textContent   = cashF.length ? fmt(cashF[cashF.length - 1][1]) : "$0";
  document.getElementById("stat-lt").textContent      = lts.length ? (lts.reduce((a,b) => a+b, 0) / lts.length).toFixed(2) + " days" : "0 days";
  document.getElementById("stat-orders").textContent   = lts.length.toLocaleString();
  document.getElementById("stat-rev").textContent      = revs.length ? fmt(revs.reduce((a,b) => a+b, 0) / revs.length) : "$0";
  const c = charts;

  const cashData = filterTS(_fullCharts.cash);
  c["chart-cash"].data.labels = cashData.map(p => p[0]);
  c["chart-cash"].data.datasets[0].data = cashData.map(p => p[1]);

  const ltData = filterTS(_fullCharts.lead_times);
  c["chart-lt"].data.datasets[0].data = ltData.map(p => ({ x: p[0], y: p[1] }));

  const u0 = filterTS(_fullCharts.util_0);
  const u1 = filterTS(_fullCharts.util_1);
  const u2 = filterTS(_fullCharts.util_2);
  c["chart-util"].data.labels = u0.map(p => p[0]);
  c["chart-util"].data.datasets[0].data = u0.map(p => p[1]);
  c["chart-util"].data.datasets[1].data = u1.map(p => p[1]);
  c["chart-util"].data.datasets[2].data = u2.map(p => p[1]);

  const invData = filterTS(_fullCharts.inventory);
  c["chart-inv"].data.labels = invData.map(p => p[0]);
  c["chart-inv"].data.datasets[0].data = invData.map(p => p[1]);

  Object.values(c).forEach(ch => ch.update("none"));
}

/* ━━ Fork from Day ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ */

function forkFromDay() {
  if (!_fullCharts) return;
  const day = _scrubDay;

  const mach = _fullCharts.machines || [];
  let m = mach.length > 0 ? mach[0][1] : [3, 2, 1];
  for (const entry of mach) { if (entry[0] <= day) m = entry[1]; else break; }

  const cashArr = _fullCharts.cash || [];
  let cash = 0;
  for (const entry of cashArr) { if (entry[0] <= day) cash = entry[1]; else break; }

  const invArr = _fullCharts.inventory || [];
  let inv = 0;
  for (const entry of invArr) { if (entry[0] <= day) inv = entry[1]; else break; }

  // Replay timeline to compute effective settings at fork day
  const origCfg = getConfig();
  let contract = Number(document.getElementById("contract").value);
  let lotSize = Number(document.getElementById("lot_size").value);
  let rop = Number(document.getElementById("reorder_point").value);
  let roq = Number(document.getElementById("order_quantity").value);
  let prio = document.getElementById("priority_step4").checked;

  const sortedTL = (origCfg.timeline || []).slice().sort((a, b) => a.day - b.day);
  for (const a of sortedTL) {
    if (a.day > day) break;
    if (a.action === "set_contract") contract = Number(a.value);
    if (a.action === "set_lot_size") lotSize = Number(a.value);
    if (a.action === "set_reorder_point") rop = Number(a.value);
    if (a.action === "set_order_quantity") roq = Number(a.value);
    if (a.action === "set_priority_step4") prio = !!Number(a.value);
  }

  // Pre-fill inputs
  document.getElementById("stuffers").value = m[0];
  document.getElementById("testers").value = m[1];
  document.getElementById("tuners").value = m[2];
  document.getElementById("start_day").value = day;
  document.getElementById("initial_cash").value = Math.round(cash);
  document.getElementById("initial_inventory").value = Math.round(inv);
  document.getElementById("contract").value = contract;
  document.getElementById("lot_size").value = lotSize;
  document.getElementById("reorder_point").value = rop;
  document.getElementById("order_quantity").value = roq;
  document.getElementById("priority_step4").checked = prio;

  // Strip timeline rows before fork day
  const futureActions = sortedTL.filter(a => a.day > day);
  document.getElementById("timeline-body").innerHTML = "";
  document.querySelectorAll("#preset-btns .preset-btn").forEach(b => b.classList.remove("active"));
  futureActions.forEach(a => addRow(a.day, a.action, a.value));

  updateDayBadge();
  updateFinalState();

  window.scrollTo({ top: 0, behavior: "smooth" });
}

/* ━━ Disclaimer ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ */

function dismissDisclaimer() {
  localStorage.setItem('disclaimer_seen', 'true');
  document.getElementById('disclaimer-overlay').classList.add('hidden');
}

(function() {
  if (localStorage.getItem('disclaimer_seen') === 'true') {
    document.getElementById('disclaimer-overlay').classList.add('hidden');
  }
})();

/* ━━ Init ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ */
loadPreset("balanced", document.getElementById("preset-balanced"));
updateDayBadge();

if (!localStorage.getItem('guide_seen')) {
  document.getElementById('guide-btn').classList.add('guide-glow');
}
</script>
</body>
</html>
